<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日の天気とコーディネート提案（PR）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントを適用 */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        /* カードのアニメーション */
        .item-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        /* ロード中のアニメーション用 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .advice-loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-blue-800">☀️ 天気連動型 コーデ提案アプリ 🛍️</h1>
        <p class="text-lg text-gray-600 mt-2">指定地域の天気に合わせたおすすめアイテムをご紹介します (PR)</p>
        
        <!-- 楽天ID設定を促す警告メッセージ -->
        <div id="rakuten-id-warning" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-4 max-w-xl mx-auto rounded-lg hidden" role="alert">
            <p class="font-bold">⚠️ 重要: 楽天APIキーを設定してください</p>
            <p class="text-sm">コード内の `RAKUTEN_APP_ID` と `RAKUTEN_AFFILIATE_ID` をご自身のIDに置き換えないと、商品が表示されません。</p>
        </div>
    </header>
    
    <!-- 地域選択エリア -->
    <div class="max-w-lg mx-auto mb-6 p-4 bg-white rounded-xl shadow-lg border-t-4 border-gray-400">
        <label for="city-select" class="block text-lg font-semibold mb-2 text-gray-700">📍 地域を選択してください:</label>
        <select id="city-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800">
            <!-- オプションはJavaScriptで動的に追加されます -->
        </select>
    </div>

    <!-- 天気情報表示エリア -->
    <div id="weather-display" class="bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-6 border-t-4 border-blue-500">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">現在の天気情報 (<span id="current-city">東京</span>)</h2>
        <div class="flex justify-between items-center text-gray-800">
            <p class="text-lg">天気: <span id="weather-text" class="font-bold text-indigo-600">取得中...</span></p>
            <p class="text-lg">気温: <span id="temperature" class="font-bold text-red-500">--</span>℃</p>
        </div>
        <p class="text-sm mt-2 text-gray-500">緯度: <span id="latitude-display">35.6895</span>, 経度: <span id="longitude-display">139.6917</span></p>
    </div>

    <!-- LLMによるファッションアドバイスエリア -->
    <div id="gemini-advice-card" class="bg-blue-50 p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-10 border-l-4 border-indigo-400">
        <h2 class="text-xl font-semibold mb-3 text-indigo-700 flex items-center">
            <span class="mr-2 text-2xl">✨</span> ファッションAIからのアドバイス
        </h2>
        <!-- 403エラー対策として、エラーメッセージを分かりやすく表示 -->
        <div id="gemini-advice" class="text-gray-700 italic text-base leading-relaxed advice-loading">アドバイスを生成中...</div>
    </div>

    <!-- 商品提案の表示エリア -->
    <main class="max-w-6xl mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-gray-700">🛒 本日のおすすめアイテム（3点）</h2>
        <div id="item-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- JavaScriptで商品カードがここに追加されます -->
        </div>
        <p id="loading-message" class="text-center text-gray-500 mt-10">データを読み込み中...</p>
    </main>

    <!-- JavaScriptコードを body の最後に配置 -->
    <script>
        // 【重要】ここに取得したIDを記述してください！
        const RAKUTEN_APP_ID = "YOUR_RAKUTEN_APPLICATION_ID"; 
        const RAKUTEN_AFFILIATE_ID = "YOUR_RAKUTEN_AFFILIATE_ID"; 

        // Gemini API設定
        const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";
        const apiKey = ""; 
        const API_URL_GEMINI = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

        // 地域データの定義 (日本の主要都市)
        const CITIES = {
            tokyo: { name: "東京", lat: 35.6895, lon: 139.6917, timezone: "Asia/Tokyo" },
            osaka: { name: "大阪", lat: 34.6937, lon: 135.5023, timezone: "Asia/Tokyo" },
            sapporo: { name: "札幌", lat: 43.0621, lon: 141.3544, timezone: "Asia/Tokyo" },
            fukuoka: { name: "福岡", lat: 33.5904, lon: 130.4017, timezone: "Asia/Tokyo" },
            naha: { name: "那覇 (沖縄)", lat: 26.2124, lon: 127.6806, timezone: "Asia/Tokyo" }
        };

        // HTML要素の参照
        const weatherTextEl = document.getElementById('weather-text');
        const temperatureEl = document.getElementById('temperature');
        const itemListEl = document.getElementById('item-list');
        const loadingMessageEl = document.getElementById('loading-message');
        const geminiAdviceEl = document.getElementById('gemini-advice');
        const rakutenWarningEl = document.getElementById('rakuten-id-warning');
        const citySelectEl = document.getElementById('city-select');
        const currentCityEl = document.getElementById('current-city');
        const latitudeDisplayEl = document.getElementById('latitude-display');
        const longitudeDisplayEl = document.getElementById('longitude-display');

        // 選択された都市を保持するグローバル変数（初期値は東京）
        let selectedCity = CITIES.tokyo;


        // 楽天IDが設定されているかチェックし、警告を表示/非表示にする
        if (RAKUTEN_APP_ID === "YOUR_RAKUTEN_APPLICATION_ID" || RAKUTEN_AFFILIATE_ID === "YOUR_RAKUTEN_AFFILIATE_ID") {
            rakutenWarningEl.classList.remove('hidden');
        } else {
            rakutenWarningEl.classList.add('hidden');
        }

        /**
         * 地域選択ドロップダウンにオプションを追加する
         */
        function initializeCitySelector() {
            for (const key in CITIES) {
                const city = CITIES[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = city.name;
                citySelectEl.appendChild(option);
            }

            // ドロップダウンの変更イベントを設定
            citySelectEl.addEventListener('change', (event) => {
                const cityKey = event.target.value;
                selectedCity = CITIES[cityKey];
                
                // 地域が変更されたらメイン処理を再実行
                main();
            });
        }

        /**
         * WMOコードから日本語の天気に変換する関数
         */
        function getWeatherText(code) {
            switch (code) {
                case 0: return "快晴";
                case 1: 
                case 2: return "晴れ（一部曇り）";
                case 3: return "曇り";
                case 45: 
                case 48: return "霧";
                case 51:
                case 53:
                case 55: return "霧雨";
                case 61:
                case 63:
                case 65: return "雨"; 
                case 80:
                case 81:
                case 82: return "にわか雨";
                case 95: return "雷雨";
                default: return "不明 (" + code + ")";
            }
        }

        /**
         * Open-Meteo APIから現在の天気情報を取得する
         */
        async function fetchWeather(city) {
            const URL = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true&temperature_unit=celsius&timezone=${city.timezone}`;
            try {
                const response = await fetch(URL);
                if (!response.ok) {
                    throw new Error(`天気APIのエラー: ${response.status}`);
                }
                const data = await response.json();
                return data.current_weather;
            } catch (error) {
                console.error("天気データの取得中にエラーが発生しました:", error);
                weatherTextEl.textContent = "取得失敗";
                temperatureEl.textContent = "E";
                return null; 
            }
        }
        
        /**
         * Gemini APIを呼び出し、天気に基づいたファッションアドバイスを取得する 
         */
        async function callGeminiAdvice(weatherText, temperature) {
            geminiAdviceEl.classList.add('advice-loading'); 
            
            const prompt = `あなたは親しみやすく知識豊富なプロのファッションアドバイザーです。今日の天気は「${weatherText}」で、気温は${temperature}℃です。この天気に最適な服装のポイントと、おすすめの素材を、3〜4行で簡潔に、絵文字を使って親しみやすい言葉でアドバイスしてください。`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL_GEMINI, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`Gemini APIエラー: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    geminiAdviceEl.classList.remove('advice-loading'); 
                    return text || "アドバイスの生成に失敗しました。";

                } catch (error) {
                    console.error("Gemini API呼び出しエラー:", error);
                    geminiAdviceEl.classList.remove('advice-loading'); 
                    // 403が継続する場合は、ユーザーに原因を伝達
                    return "AIアドバイスの取得に失敗しました。認証エラー(403)の可能性があります。";
                }
            }
            return "AIアドバイスの取得中にエラーが発生しました。";
        }


        /**
         * 気温と天気コードに基づき、楽天検索用のキーワードを生成する
         */
        function generateKeywords(temperature, weatherCode) {
            let keywords = "";
            
            // 1. 気温による基本キーワードの決定
            if (temperature >= 30) {
                keywords = "涼しい Tシャツ リネン";
            } else if (temperature >= 20) {
                keywords = "半袖 シャツ カーディガン";
            } else if (temperature >= 10) {
                keywords = "薄手 ニット トレンチコート";
            } else if (temperature >= 0) {
                keywords = "ダウンジャケット マフラー";
            } else {
                keywords = "極暖 ヒートテック";
            }

            // 2. 雨天対策（天気コードによる判断）
            if ([61, 63, 65, 80, 81, 82].includes(weatherCode)) {
                keywords += " 撥水 防水 レイングッズ"; 
            }

            // 3. 服飾カテゴリに絞る
            keywords += " 服飾 ファッション";
            
            return keywords;
        }

        /**
         * 楽天APIから商品を取得
         */
        async function fetchRakutenItems(keyword) {
            if (RAKUTEN_APP_ID === "YOUR_RAKUTEN_APPLICATION_ID") {
                 // ID未設定時のダミーデータ
                 return [
                    { itemName: "【ダミー】APIキーを設定して！", itemPrice: 9999, mediumImageUrls: [{ imageUrl: "https://placehold.co/128x128/FF5733/ffffff?text=No+API+ID" }], itemUrl: "#" },
                    { itemName: "【ダミー】気温:" + keyword.split(' ')[0], itemPrice: 7777, mediumImageUrls: [{ imageUrl: "https://placehold.co/128x128/33C4FF/ffffff?text=Set+ID" }], itemUrl: "#" },
                    { itemName: "【ダミー】天気:" + getWeatherText(0), itemPrice: 5555, mediumImageUrls: [{ imageUrl: "https://placehold.co/128x128/33FF5B/ffffff?text=PR+Item" }], itemUrl: "#" }
                 ];
            }

            const RAKUTEN_URL = `https://app.rakuten.co.jp/services/api/IchibaItem/Search/20170706?format=json&keyword=${encodeURIComponent(keyword)}&applicationId=${RAKUTEN_APP_ID}&affiliateId=${RAKUTEN_AFFILIATE_ID}&hits=3&sort=-affiliateRate`;
            
            try {
                const response = await fetch(RAKUTEN_URL);
                const data = await response.json();

                if (data.Items && data.Items.length > 0) {
                    return data.Items.map(itemWrapper => {
                        const item = itemWrapper.Item;
                        return {
                            itemName: item.itemName,
                            itemPrice: item.itemPrice,
                            mediumImageUrls: item.mediumImageUrls,
                            itemUrl: item.affiliateUrl || item.itemUrl
                        };
                    });
                } else {
                    console.warn("楽天API: 該当する商品が見つかりませんでした。キーワード:", keyword);
                    return [];
                }

            } catch (error) {
                console.error("楽天API呼び出し中にエラーが発生:", error);
                return [];
            }
        }

        /**
         * 画面に商品を表示 (DOM操作)
         */
        function renderItems(items, keyword) {
            itemListEl.innerHTML = ''; // コンテナをクリア
            loadingMessageEl.style.display = 'none';

            if (items.length === 0) {
                itemListEl.innerHTML = `<p class="text-center text-xl text-gray-500 col-span-full p-10 bg-white rounded-xl shadow-inner">
                    検索キーワード「${keyword}」に該当する商品が見つかりませんでした。
                </p>`;
                return;
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card bg-white p-4 rounded-xl shadow-md border border-gray-100 hover:shadow-xl';
                
                const imageUrl = item.mediumImageUrls && item.mediumImageUrls.length > 0
                                ? item.mediumImageUrls[0].imageUrl
                                : 'https://placehold.co/128x128/aaaaaa/ffffff?text=No+Image';

                card.innerHTML = `
                    <div class="flex flex-col items-center">
                        <img src="${imageUrl}" alt="${item.itemName}" onerror="this.onerror=null;this.src='https://placehold.co/128x128/aaaaaa/ffffff?text=画像なし';"
                             class="w-32 h-32 object-contain rounded-lg mb-3 border p-1 bg-white">
                        
                        <p class="text-sm font-medium text-gray-900 h-10 overflow-hidden mb-2">${item.itemName}</p>
                        
                        <p class="text-xl font-bold text-green-600 mb-3">¥${item.itemPrice.toLocaleString()}</p>
                        
                        <a href="${item.itemUrl}" target="_blank" rel="noopener noreferrer" 
                           class="w-full text-center bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                           楽天市場で見る (PR)
                        </a>
                    </div>
                `;
                itemListEl.appendChild(card);
            });
        }

        /**
         * メイン処理の実行（天気取得 → LLMアドバイス生成 → キーワード生成 → 商品取得 → 表示）
         */
        async function main() {
            loadingMessageEl.textContent = `${selectedCity.name}の天気情報を取得中...`;

            // 地域表示を更新
            currentCityEl.textContent = selectedCity.name;
            latitudeDisplayEl.textContent = selectedCity.lat;
            longitudeDisplayEl.textContent = selectedCity.lon;

            // 1. 天気データを取得
            const weatherData = await fetchWeather(selectedCity);
            
            if (!weatherData) {
                loadingMessageEl.textContent = 'データの取得に失敗しました。';
                return;
            }

            // 画面に天気情報を表示
            const weatherCode = weatherData.weathercode;
            const weatherText = getWeatherText(weatherCode);
            const temperature = weatherData.temperature;

            weatherTextEl.textContent = weatherText;
            temperatureEl.textContent = temperature;
            
            // --- LLM機能の追加 ---
            geminiAdviceEl.innerHTML = '<span class="advice-loading">ファッションAIがアドバイスを考えています...</span>';
            const advice = await callGeminiAdvice(weatherText, temperature);
            geminiAdviceEl.innerHTML = advice.replace(/\n/g, '<br>'); 
            // ---------------------

            loadingMessageEl.textContent = `キーワード生成中... (${weatherText}, ${temperature}℃)`;
            
            // 2. キーワード生成
            const keyword = generateKeywords(temperature, weatherCode);
            console.log("生成された検索キーワード:", keyword);

            loadingMessageEl.textContent = `楽天で「${keyword}」を検索中...`;
            
            // 3. 楽天商品を取得
            const items = await fetchRakutenItems(keyword);
            
            // 4. 画面に表示
            renderItems(items, keyword);
        }

        // ページロード時に実行
        initializeCitySelector();
        main();
    </script>
</body>
</html>
