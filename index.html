<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šæ—¥ã®å¤©æ°—ã¨ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ãƒˆææ¡ˆï¼ˆPRï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        /* ã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .item-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        /* ãƒ­ãƒ¼ãƒ‰ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .advice-loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-blue-800">â˜€ï¸ å¤©æ°—é€£å‹•å‹ ã‚³ãƒ¼ãƒ‡ææ¡ˆã‚¢ãƒ—ãƒª ğŸ›ï¸</h1>
        <p class="text-lg text-gray-600 mt-2">æŒ‡å®šåœ°åŸŸã®å¤©æ°—ã«åˆã‚ã›ãŸãŠã™ã™ã‚ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã”ç´¹ä»‹ã—ã¾ã™ (PR)</p>
        
        <!-- æ¥½å¤©IDè¨­å®šã‚’ä¿ƒã™è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="rakuten-id-warning" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-4 max-w-xl mx-auto rounded-lg hidden" role="alert">
            <p class="font-bold">âš ï¸ é‡è¦: æ¥½å¤©APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
            <p class="text-sm">ã‚³ãƒ¼ãƒ‰å†…ã® `RAKUTEN_APP_ID` ã¨ `RAKUTEN_AFFILIATE_ID` ã‚’ã”è‡ªèº«ã®IDã«ç½®ãæ›ãˆãªã„ã¨ã€å•†å“ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</p>
        </div>
    </header>
    
    <!-- åœ°åŸŸé¸æŠã‚¨ãƒªã‚¢ -->
    <div class="max-w-lg mx-auto mb-6 p-4 bg-white rounded-xl shadow-lg border-t-4 border-gray-400">
        <label for="city-select" class="block text-lg font-semibold mb-2 text-gray-700">ğŸ“ åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„:</label>
        <select id="city-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800">
            <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </select>
    </div>

    <!-- å¤©æ°—æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="weather-display" class="bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-6 border-t-4 border-blue-500">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">ç¾åœ¨ã®å¤©æ°—æƒ…å ± (<span id="current-city">æ±äº¬</span>)</h2>
        <div class="flex justify-between items-center text-gray-800">
            <p class="text-lg">å¤©æ°—: <span id="weather-text" class="font-bold text-indigo-600">å–å¾—ä¸­...</span></p>
            <p class="text-lg">æ°—æ¸©: <span id="temperature" class="font-bold text-red-500">--</span>â„ƒ</p>
        </div>
        <p class="text-sm mt-2 text-gray-500">ç·¯åº¦: <span id="latitude-display">35.6895</span>, çµŒåº¦: <span id="longitude-display">139.6917</span></p>
    </div>

    <!-- LLMã«ã‚ˆã‚‹ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚¨ãƒªã‚¢ -->
    <div id="gemini-advice-card" class="bg-blue-50 p-6 rounded-xl shadow-lg max-w-lg mx-auto mb-10 border-l-4 border-indigo-400">
        <h2 class="text-xl font-semibold mb-3 text-indigo-700 flex items-center">
            <span class="mr-2 text-2xl">âœ¨</span> ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
        </h2>
        <!-- 403ã‚¨ãƒ©ãƒ¼å¯¾ç­–ã¨ã—ã¦ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè¡¨ç¤º -->
        <div id="gemini-advice" class="text-gray-700 italic text-base leading-relaxed advice-loading">ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆä¸­...</div>
    </div>

    <!-- å•†å“ææ¡ˆã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <main class="max-w-6xl mx-auto">
        <h2 class="text-2xl font-bold mb-6 text-gray-700">ğŸ›’ æœ¬æ—¥ã®ãŠã™ã™ã‚ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆ3ç‚¹ï¼‰</h2>
        <div id="item-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- JavaScriptã§å•†å“ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
        <p id="loading-message" class="text-center text-gray-500 mt-10">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </main>

    <!-- JavaScriptã‚³ãƒ¼ãƒ‰ã‚’ body ã®æœ€å¾Œã«é…ç½® -->
    <script>
        // ã€é‡è¦ã€‘ã“ã“ã«å–å¾—ã—ãŸIDã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ï¼
        const RAKUTEN_APP_ID = "YOUR_RAKUTEN_APPLICATION_ID"; 
        const RAKUTEN_AFFILIATE_ID = "YOUR_RAKUTEN_AFFILIATE_ID"; 

        // Gemini APIè¨­å®š
        const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";
        const apiKey = ""; 
        const API_URL_GEMINI = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

        // åœ°åŸŸãƒ‡ãƒ¼ã‚¿ã®å®šç¾© (æ—¥æœ¬ã®ä¸»è¦éƒ½å¸‚)
        const CITIES = {
            tokyo: { name: "æ±äº¬", lat: 35.6895, lon: 139.6917, timezone: "Asia/Tokyo" },
            osaka: { name: "å¤§é˜ª", lat: 34.6937, lon: 135.5023, timezone: "Asia/Tokyo" },
            sapporo: { name: "æœ­å¹Œ", lat: 43.0621, lon: 141.3544, timezone: "Asia/Tokyo" },
            fukuoka: { name: "ç¦å²¡", lat: 33.5904, lon: 130.4017, timezone: "Asia/Tokyo" },
            naha: { name: "é‚£è¦‡ (æ²–ç¸„)", lat: 26.2124, lon: 127.6806, timezone: "Asia/Tokyo" }
        };

        // HTMLè¦ç´ ã®å‚ç…§
        const weatherTextEl = document.getElementById('weather-text');
        const temperatureEl = document.getElementById('temperature');
        const itemListEl = document.getElementById('item-list');
        const loadingMessageEl = document.getElementById('loading-message');
        const geminiAdviceEl = document.getElementById('gemini-advice');
        const rakutenWarningEl = document.getElementById('rakuten-id-warning');
        const citySelectEl = document.getElementById('city-select');
        const currentCityEl = document.getElementById('current-city');
        const latitudeDisplayEl = document.getElementById('latitude-display');
        const longitudeDisplayEl = document.getElementById('longitude-display');

        // é¸æŠã•ã‚ŒãŸéƒ½å¸‚ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆåˆæœŸå€¤ã¯æ±äº¬ï¼‰
        let selectedCity = CITIES.tokyo;


        // æ¥½å¤©IDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã€è­¦å‘Šã‚’è¡¨ç¤º/éè¡¨ç¤ºã«ã™ã‚‹
        if (RAKUTEN_APP_ID === "YOUR_RAKUTEN_APPLICATION_ID" || RAKUTEN_AFFILIATE_ID === "YOUR_RAKUTEN_AFFILIATE_ID") {
            rakutenWarningEl.classList.remove('hidden');
        } else {
            rakutenWarningEl.classList.add('hidden');
        }

        /**
         * åœ°åŸŸé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹
         */
        function initializeCitySelector() {
            for (const key in CITIES) {
                const city = CITIES[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = city.name;
                citySelectEl.appendChild(option);
            }

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            citySelectEl.addEventListener('change', (event) => {
                const cityKey = event.target.value;
                selectedCity = CITIES[cityKey];
                
                // åœ°åŸŸãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’å†å®Ÿè¡Œ
                main();
            });
        }

        /**
         * WMOã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ—¥æœ¬èªã®å¤©æ°—ã«å¤‰æ›ã™ã‚‹é–¢æ•°
         */
        function getWeatherText(code) {
            switch (code) {
                case 0: return "å¿«æ™´";
                case 1: 
                case 2: return "æ™´ã‚Œï¼ˆä¸€éƒ¨æ›‡ã‚Šï¼‰";
                case 3: return "æ›‡ã‚Š";
                case 45: 
                case 48: return "éœ§";
                case 51:
                case 53:
                case 55: return "éœ§é›¨";
                case 61:
                case 63:
                case 65: return "é›¨"; 
                case 80:
                case 81:
                case 82: return "ã«ã‚ã‹é›¨";
                case 95: return "é›·é›¨";
                default: return "ä¸æ˜ (" + code + ")";
            }
        }

        /**
         * Open-Meteo APIã‹ã‚‰ç¾åœ¨ã®å¤©æ°—æƒ…å ±ã‚’å–å¾—ã™ã‚‹
         */
        async function fetchWeather(city) {
            const URL = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true&temperature_unit=celsius&timezone=${city.timezone}`;
            try {
                const response = await fetch(URL);
                if (!response.ok) {
                    throw new Error(`å¤©æ°—APIã®ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
                const data = await response.json();
                return data.current_weather;
            } catch (error) {
                console.error("å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                weatherTextEl.textContent = "å–å¾—å¤±æ•—";
                temperatureEl.textContent = "E";
                return null; 
            }
        }
        
        /**
         * Gemini APIã‚’å‘¼ã³å‡ºã—ã€å¤©æ°—ã«åŸºã¥ã„ãŸãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—ã™ã‚‹ 
         */
        async function callGeminiAdvice(weatherText, temperature) {
            geminiAdviceEl.classList.add('advice-loading'); 
            
            const prompt = `ã‚ãªãŸã¯è¦ªã—ã¿ã‚„ã™ãçŸ¥è­˜è±Šå¯Œãªãƒ—ãƒ­ã®ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ä»Šæ—¥ã®å¤©æ°—ã¯ã€Œ${weatherText}ã€ã§ã€æ°—æ¸©ã¯${temperature}â„ƒã§ã™ã€‚ã“ã®å¤©æ°—ã«æœ€é©ãªæœè£…ã®ãƒã‚¤ãƒ³ãƒˆã¨ã€ãŠã™ã™ã‚ã®ç´ æã‚’ã€3ã€œ4è¡Œã§ç°¡æ½”ã«ã€çµµæ–‡å­—ã‚’ä½¿ã£ã¦è¦ªã—ã¿ã‚„ã™ã„è¨€è‘‰ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL_GEMINI, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`Gemini APIã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    geminiAdviceEl.classList.remove('advice-loading'); 
                    return text || "ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚";

                } catch (error) {
                    console.error("Gemini APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:", error);
                    geminiAdviceEl.classList.remove('advice-loading'); 
                    // 403ãŒç¶™ç¶šã™ã‚‹å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åŸå› ã‚’ä¼é”
                    return "AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚èªè¨¼ã‚¨ãƒ©ãƒ¼(403)ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
                }
            }
            return "AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
        }


        /**
         * æ°—æ¸©ã¨å¤©æ°—ã‚³ãƒ¼ãƒ‰ã«åŸºã¥ãã€æ¥½å¤©æ¤œç´¢ç”¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹
         */
        function generateKeywords(temperature, weatherCode) {
            let keywords = "";
            
            // 1. æ°—æ¸©ã«ã‚ˆã‚‹åŸºæœ¬ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ±ºå®š
            if (temperature >= 30) {
                keywords = "æ¶¼ã—ã„ Tã‚·ãƒ£ãƒ„ ãƒªãƒãƒ³";
            } else if (temperature >= 20) {
                keywords = "åŠè¢– ã‚·ãƒ£ãƒ„ ã‚«ãƒ¼ãƒ‡ã‚£ã‚¬ãƒ³";
            } else if (temperature >= 10) {
                keywords = "è–„æ‰‹ ãƒ‹ãƒƒãƒˆ ãƒˆãƒ¬ãƒ³ãƒã‚³ãƒ¼ãƒˆ";
            } else if (temperature >= 0) {
                keywords = "ãƒ€ã‚¦ãƒ³ã‚¸ãƒ£ã‚±ãƒƒãƒˆ ãƒãƒ•ãƒ©ãƒ¼";
            } else {
                keywords = "æ¥µæš– ãƒ’ãƒ¼ãƒˆãƒ†ãƒƒã‚¯";
            }

            // 2. é›¨å¤©å¯¾ç­–ï¼ˆå¤©æ°—ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹åˆ¤æ–­ï¼‰
            if ([61, 63, 65, 80, 81, 82].includes(weatherCode)) {
                keywords += " æ’¥æ°´ é˜²æ°´ ãƒ¬ã‚¤ãƒ³ã‚°ãƒƒã‚º"; 
            }

            // 3. æœé£¾ã‚«ãƒ†ã‚´ãƒªã«çµã‚‹
            keywords += " æœé£¾ ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³";
            
            return keywords;
        }

        /**
         * æ¥½å¤©APIã‹ã‚‰å•†å“ã‚’å–å¾—
         */
        async function fetchRakutenItems(keyword) {
            if (RAKUTEN_APP_ID === "YOUR_RAKUTEN_APPLICATION_ID") {
                 // IDæœªè¨­å®šæ™‚ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
                 return [
                    { itemName: "ã€ãƒ€ãƒŸãƒ¼ã€‘APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ï¼", itemPrice: 9999, mediumImageUrls: [{ imageUrl: "https://placehold.co/128x128/FF5733/ffffff?text=No+API+ID" }], itemUrl: "#" },
                    { itemName: "ã€ãƒ€ãƒŸãƒ¼ã€‘æ°—æ¸©:" + keyword.split(' ')[0], itemPrice: 7777, mediumImageUrls: [{ imageUrl: "https://placehold.co/128x128/33C4FF/ffffff?text=Set+ID" }], itemUrl: "#" },
                    { itemName: "ã€ãƒ€ãƒŸãƒ¼ã€‘å¤©æ°—:" + getWeatherText(0), itemPrice: 5555, mediumImageUrls: [{ imageUrl: "https://placehold.co/128x128/33FF5B/ffffff?text=PR+Item" }], itemUrl: "#" }
                 ];
            }

            const RAKUTEN_URL = `https://app.rakuten.co.jp/services/api/IchibaItem/Search/20170706?format=json&keyword=${encodeURIComponent(keyword)}&applicationId=${RAKUTEN_APP_ID}&affiliateId=${RAKUTEN_AFFILIATE_ID}&hits=3&sort=-affiliateRate`;
            
            try {
                const response = await fetch(RAKUTEN_URL);
                const data = await response.json();

                if (data.Items && data.Items.length > 0) {
                    return data.Items.map(itemWrapper => {
                        const item = itemWrapper.Item;
                        return {
                            itemName: item.itemName,
                            itemPrice: item.itemPrice,
                            mediumImageUrls: item.mediumImageUrls,
                            itemUrl: item.affiliateUrl || item.itemUrl
                        };
                    });
                } else {
                    console.warn("æ¥½å¤©API: è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:", keyword);
                    return [];
                }

            } catch (error) {
                console.error("æ¥½å¤©APIå‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:", error);
                return [];
            }
        }

        /**
         * ç”»é¢ã«å•†å“ã‚’è¡¨ç¤º (DOMæ“ä½œ)
         */
        function renderItems(items, keyword) {
            itemListEl.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
            loadingMessageEl.style.display = 'none';

            if (items.length === 0) {
                itemListEl.innerHTML = `<p class="text-center text-xl text-gray-500 col-span-full p-10 bg-white rounded-xl shadow-inner">
                    æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œ${keyword}ã€ã«è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
                </p>`;
                return;
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card bg-white p-4 rounded-xl shadow-md border border-gray-100 hover:shadow-xl';
                
                const imageUrl = item.mediumImageUrls && item.mediumImageUrls.length > 0
                                ? item.mediumImageUrls[0].imageUrl
                                : 'https://placehold.co/128x128/aaaaaa/ffffff?text=No+Image';

                card.innerHTML = `
                    <div class="flex flex-col items-center">
                        <img src="${imageUrl}" alt="${item.itemName}" onerror="this.onerror=null;this.src='https://placehold.co/128x128/aaaaaa/ffffff?text=ç”»åƒãªã—';"
                             class="w-32 h-32 object-contain rounded-lg mb-3 border p-1 bg-white">
                        
                        <p class="text-sm font-medium text-gray-900 h-10 overflow-hidden mb-2">${item.itemName}</p>
                        
                        <p class="text-xl font-bold text-green-600 mb-3">Â¥${item.itemPrice.toLocaleString()}</p>
                        
                        <a href="${item.itemUrl}" target="_blank" rel="noopener noreferrer" 
                           class="w-full text-center bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                           æ¥½å¤©å¸‚å ´ã§è¦‹ã‚‹ (PR)
                        </a>
                    </div>
                `;
                itemListEl.appendChild(card);
            });
        }

        /**
         * ãƒ¡ã‚¤ãƒ³å‡¦ç†ã®å®Ÿè¡Œï¼ˆå¤©æ°—å–å¾— â†’ LLMã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ â†’ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ â†’ å•†å“å–å¾— â†’ è¡¨ç¤ºï¼‰
         */
        async function main() {
            loadingMessageEl.textContent = `${selectedCity.name}ã®å¤©æ°—æƒ…å ±ã‚’å–å¾—ä¸­...`;

            // åœ°åŸŸè¡¨ç¤ºã‚’æ›´æ–°
            currentCityEl.textContent = selectedCity.name;
            latitudeDisplayEl.textContent = selectedCity.lat;
            longitudeDisplayEl.textContent = selectedCity.lon;

            // 1. å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const weatherData = await fetchWeather(selectedCity);
            
            if (!weatherData) {
                loadingMessageEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                return;
            }

            // ç”»é¢ã«å¤©æ°—æƒ…å ±ã‚’è¡¨ç¤º
            const weatherCode = weatherData.weathercode;
            const weatherText = getWeatherText(weatherCode);
            const temperature = weatherData.temperature;

            weatherTextEl.textContent = weatherText;
            temperatureEl.textContent = temperature;
            
            // --- LLMæ©Ÿèƒ½ã®è¿½åŠ  ---
            geminiAdviceEl.innerHTML = '<span class="advice-loading">ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³AIãŒã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è€ƒãˆã¦ã„ã¾ã™...</span>';
            const advice = await callGeminiAdvice(weatherText, temperature);
            geminiAdviceEl.innerHTML = advice.replace(/\n/g, '<br>'); 
            // ---------------------

            loadingMessageEl.textContent = `ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆä¸­... (${weatherText}, ${temperature}â„ƒ)`;
            
            // 2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
            const keyword = generateKeywords(temperature, weatherCode);
            console.log("ç”Ÿæˆã•ã‚ŒãŸæ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:", keyword);

            loadingMessageEl.textContent = `æ¥½å¤©ã§ã€Œ${keyword}ã€ã‚’æ¤œç´¢ä¸­...`;
            
            // 3. æ¥½å¤©å•†å“ã‚’å–å¾—
            const items = await fetchRakutenItems(keyword);
            
            // 4. ç”»é¢ã«è¡¨ç¤º
            renderItems(items, keyword);
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
        initializeCitySelector();
        main();
    </script>
</body>
</html>
